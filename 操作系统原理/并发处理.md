# 并发处理
## 并发活动-进程的引入
#### 顺序执行

一个计算由若干个操作组成，而这些操作必须按照某种先后次序来执行，以保证操作的结果是正确的，则这类计算过程是程序的顺序执行过程。

- 顺序性:每个操作必须在下一个操作开始执行前结束。
- 封闭性：程序一旦开始执行，其结果不受外界因素的影响。
- 可再现性程序执行的结果与它的执行速度无关（与时间无关），只与初始条件有关。

#### 程序的并发执行

若干个程序段同时在系统中运行，这些程序段的执行在时间上是重叠的，一个程序段的执行尚未结束，另一个程序段的执行已经开始，即使这种重叠是很小的一部分，也称这几个程序断是并发执行的。用以下语句表示。

```
cobegin
	S1;S2;S3;
coend
```

#### 与时间有关的错误

程序并发执行时若共享了公共变量，则一个程序的执行会改变另一个程序的变量，因此其输出结果将受外界的影响而失去封闭性，其执行结果将与并发程序执行的相对速度有关，即给定相同的初始条件，也可能会得到不同的结果，此为与时间有关的错误。为了保证得到唯一的结果，需要实现并发程序执行时的互斥和同步。

#### 并发程序的特点

- 失去程序的封闭性
- 程序与计算不再一一对应
- 程序并发执行相互制约

## 进程概念

### 进程的定义
进程是处理机活动的一个抽象概念。是指一个具有一定独立功能的程序关于某个数据集合的一次运行活动。

进程和程序是既有联系又有区别的两个概念：
- 程序是指令的有序集合，其本身没有任何运行的含义，它是一个静态概念。而进程是程序在处理机上的一次执行过程，它是一个动态概念。程序作为一种软件资料长期保存，而进程则是有一定的生命周期，可以动态的产生和消亡。
- 进程是一个能独立运行的单位，能与其他进程并行的活动。
- 进程是竞争计算机系统有限资源的基本单位，也是进行处理机调度的基本单位。

### 进程的类型

有些进程起着资源管理和控制的作用，称为系统进程；而另一些是为用户算题任务而建立的进程称为用户进程。

- 系统进程被分配一个初始的资源集合，这些资源可为它所独占，也可以最高优先级的资格优先使用。用户进程通过系统服务请求的手段竞争系统资源。
- 用户进程不能做直接I/O操作，而系统进程可以做显示的、直接的I/O操作。
- 系统进程在管态下活动，而用户进程在用户态下活动。

### 进程的状态
#### 进程的基本状态

- 就绪状态：当进程获得了除CPU之外所有的资源，它已经准备就绪，一旦得到了CPU控制权，就可以立即运行，该进程所处的状态为就绪状态。
- 运行状态：当进程由调度/分派模块分派后，得到中央处理机控制权，它的程序正在运行，该进程所处的状态为运行状态。
- 等待状态：若一进程正在等待某一事件发生而暂时停止执行，即使给它CPU控制权，它也无法执行，则称该进程处于等待状态，又称为**阻塞状态**。

#### 进程状态变迁图

进程并非固定处于某个状态，它将随着自身的推进和外界条件的变化而发生变化。
![](https://github.com/imgaojp/note/raw/master/images/进程基本变迁.JPG)

#### 进程的描述-进程控制块

进程是程序一次执行过程。程序是完成该进程活动的算法描述。为了刻画一个进程在各个不同时期所处的状态，人们采用了一个与进程相联系的数据块，称为进程控制块（PCB）或者进程描述器（process descriptor）。当系统创建一个进程时，必须为它设置一个pcb，然后根据pcb信息对进程实施控制管理。进程任务完成时，系统撤销它的pcb，进程也随之消亡。

pcb的结构如下：

>name：唯一的进程标识符。
>status：进程的当前状态。
>next：当前队列指针。
>all_q_next：总链指针。
>start_addr：程序开始地址。
>priority：进程的优先级。
>CPUstatus：CPU现场保护区。
>communication_information：通信信息。
>process_family：家族联系。
>own_resource：占有资源清单。

### 线程概念及特点
#### 什么是线程

线程是比进程更小的活动单位，它是进程中的一个执行路径。一个进程可以有多个执行路径，即线程。在一个进程内部就有多个可以独立活动的单位，可以加快进程处理的速度，进一步提高系统的并行处理能力。

- 线程是进程中的一条路径
- 它有自己私用的堆栈和处理机执行环境
- 它共享分配给父进程的主存
- 它是单个进程所创建的许多个同时存在的线程中的一个

**进程和线程既有联系又有区别，对于进程的组成可以高度概括为以下几个方面：**

- 一个可执行程序，它定义了初始代码和数据
- 一个私用地址空间，它是进程可以使用的一组虚拟主存地址
- 进程执行时所需的系统资源（文件、信号灯、通信端口等），是由操作系统分配给进程的
- 若系统支持线程运行，那么每个进程至少有一个执行线程

进程是任务调度的单位，也是系统资源分配的单位；而线程是进程中的一条执行路径，当系统支持多线程时，线程是任务调度的单位，但不是系统资源分配单位。线程完全继承父进程占有的资源，当它活动时，具有自己的运行现场。
#### 线程的特点与状态

- 线程的特点：相对进程而言，线程的创建与管理的开销要小得多。因为线程可以共享父进程的所有程序和全局数据，创建一个新的线程只涉及最小量的主存分配，也意味着一个进程创建的多个线程可以共享地址区域和数据。在进程内创建多线程可以提高系统的并行处理能力。
- 线程的状态变迁：如果一个系统支持线程的创建与线程的活动，那么处理机调度的最小单位是线程而不是进程。线程是争夺CPU的单位。
	- 创建。建立一个新线程，新生的线程将处于新建状态。此时它已经具有了相应地主存空间和其他资源，并已被初始化。
	- 就绪。线程处于线程就绪队列中，并等待被调度。此时已经具备了运行的条件，一旦分配到CPU时间，就可以立即去运行。
	- 运行。一个线程正占用CPU，执行它的程序。
	- 等待。一个正在执行的线程，如果发生某些事件，如被挂起或需要执行费时的输入/输出操作时，将让出CPU，暂时中止自己的执行，进入等待状态。等待另一个线程唤醒它。
	- 终止。一个线程已经退出，但该信息还没被其它线程所收集。

！[](https://github.com/Imgaojp/Note/raw/master/images/线程的生命周期.JPG)

